<template>
  <div class="main-label-manager">
    <div class="mlm-header">
      <input
        v-model="search"
        class="mlm-search"
        type="text"
        placeholder="æœç´¢æ ‡ç­¾â€?
      />
      <button class="mlm-add" @click="createNew">+ æ–°å»ºæ ‡ç­¾</button>
      <div class="mlm-grid">
        <button class="mlm-sort" @click="toggleTimeSort">
          æŒ‰æ—¶é—?{{ sortTimeDesc ? 'åâ†’å…? : 'å…ˆâ†’å? }}
        </button>
        <button class="mlm-sort" @click="toggleNameSort">
          æŒ‰åç§?{{ sortNameAsc ? 'Aâ†’Z' : 'Zâ†’A' }}
        </button>
        <button class="mlm-edit" :disabled="!current" @click="renameSelected">ç¼–è¾‘</button>
        <button class="mlm-delete" :disabled="!current" @click="deleteSelected">åˆ é™¤</button>
      </div>
    </div>

    <div class="mlm-list">
      <div
        v-for="item in sortedList"
        :key="item.id"
        :class="['mlm-item', { active: item.id === internalSelectedId, pinned: !!item.pinned, highlighted: !!item.highlighted }]"
        @click="selectItem(item)"
        :title="item.updatedAt ? formatTime(item.updatedAt) : ''"
      >
        <div class="mlm-item-main">
          <span v-if="item.pinned" class="pin-badge">[ç½®é¡¶]</span>
          <span class="mlm-name">{{ item.name }}</span>
        </div>
        <div class="mlm-item-actions">
          <button class="mini-btn" :title="item.pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'" @click.stop="togglePin(item)">
            <svg viewBox="0 0 24 24" width="14" height="14"><path d="M14 2l-1 4.5 4 4-4.5-1L7 16l1-4.5L4 7l4.5 1L14 2z"/></svg>
          </button>
          <button class="mini-btn" :title="item.highlighted ? 'å–æ¶ˆé«˜äº®' : 'é«˜äº®'" @click.stop="toggleHighlight(item)">
            <svg viewBox="0 0 24 24" width="14" height="14"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- åŸåº•éƒ¨æ“ä½œåŒºå·²ä¸Šç§»åˆ°æ–°å»ºæŒ‰é’®ä¸‹æ–¹ -->
  </div>
  
</template>

<script setup>
import { ref, computed, watch, onMounted, defineExpose } from 'vue'

const STORAGE_KEY = 'weilin_prompt_ui_main_labels_v1'

// é€‰ä¸­é¡¹ç”±å†…éƒ¨ç»´æŠ¤ï¼Œä¹Ÿå…è®¸çˆ¶ç»„ä»¶é€šè¿‡ props è®¾ç½®åˆå§‹é€‰ä¸­
const props = defineProps({
  selectedId: { type: String, default: null }
})

const emit = defineEmits(['select'])

const search = ref('')
const items = ref([]) // { id, name, content, createdAt, updatedAt, pinned, highlighted }
const internalSelectedId = ref(props.selectedId)

onMounted(() => {
  load()
  // å¦‚æœæ²¡æœ‰ä»»ä½•æ ‡ç­¾ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ç¤ºä¾‹
  if (items.value.length === 0) {
    const id = genId()
    items.value.push({
      id,
      name: 'ç¤ºä¾‹æ ‡ç­¾',
      content: '',
      createdAt: Date.now(),
      updatedAt: Date.now()
    })
    save()
    internalSelectedId.value = id
    emit('select', getById(id))
  }
})

watch(() => props.selectedId, (v) => {
  internalSelectedId.value = v
})

const sortTimeDesc = ref(true)
const sortNameAsc = ref(true)
const sortMode = ref('time') // 'time' | 'name'

const filtered = computed(() => {
  const q = search.value.trim().toLowerCase()
  if (!q) return items.value
  return items.value.filter(i =>
    (i.name || '').toLowerCase().includes(q)
  )
})

// æ–°çš„æ’åºé€»è¾‘ï¼šæ ¹æ?sortMode å†³å®šæŒ‰æ—¶é—´æˆ–åç§°æ’åº
const sortedList = computed(() => {
  const arr = [...filtered.value]

  const cmpName = (a, b) => {
    const na = (a.name || '')
    const nb = (b.name || '')
    let cmp = na.localeCompare(nb, undefined, { numeric: true, sensitivity: 'base' })
    if (!sortNameAsc.value) cmp = -cmp
    return cmp
  }

  const cmpTime = (a, b) => {
    let cmp = a.createdAt - b.createdAt
    if (sortTimeDesc.value) cmp = -cmp
    return cmp
  }

  const groupWeight = (x) => (x.pinned ? 0 : x.highlighted ? 1 : 2)

  arr.sort((a, b) => {
    const gw = groupWeight(a) - groupWeight(b)
    if (gw !== 0) return gw
    if (sortMode.value === 'name') {
      const n = cmpName(a, b)
      if (n !== 0) return n
      return cmpTime(a, b)
    }
    const t = cmpTime(a, b)
    if (t !== 0) return t
    return cmpName(a, b)
  })

  return arr
})

const sortedAndFiltered = computed(() => {
  const arr = [...filtered.value]
  // ä½¿ç”¨åˆ›å»ºæ—¶é—´è¿›è¡Œâ€œæŒ‰æ—¶é—´â€æ’åºï¼Œç¼–è¾‘ä¸ä¼šæ”¹å˜é¡ºåº
  arr.sort((a, b) => {
    // æ—¶é—´æ’åºï¼ˆä½¿ç”?createdAtï¼?    if (a.createdAt !== b.createdAt) {
      return sortTimeDesc.value ? (b.createdAt - a.createdAt) : (a.createdAt - b.createdAt)
    }
    // åç§°æ’åºä½œä¸ºæ¬¡åº
    const na = (a.name || '').toLowerCase()
    const nb = (b.name || '').toLowerCase()
    if (na === nb) return 0
    return sortNameAsc.value ? (na < nb ? -1 : 1) : (na > nb ? -1 : 1)
  })
  return arr
})

const current = computed(() => getById(internalSelectedId.value))

function genId() {
  return 'mlm_' + Math.random().toString(36).slice(2) + '_' + Date.now()
}

function load() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY)
    const arr = raw ? JSON.parse(raw) : []
    // å…¼å®¹æ—§æ•°æ®ï¼Œè¡¥é½åˆ›å»º/æ›´æ–°æ—¶é—´
    items.value = arr.map(i => ({
      ...i,
      createdAt: i?.createdAt ?? i?.updatedAt ?? Date.now(),
      updatedAt: i?.updatedAt ?? i?.createdAt ?? Date.now(),
      pinned: !!i?.pinned,
      highlighted: !!i?.highlighted,
    }))
  } catch (e) {
    items.value = []
  }
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(items.value))
}

function getById(id) {
  return items.value.find(i => i.id === id) || null
}

function selectItem(item) {
  internalSelectedId.value = item.id
  emit('select', { ...item })
}

function createNew() {
  const name = window.prompt('æ–°å»ºæ ‡ç­¾åç§°ï¼?, '')
  if (!name) return
  const id = genId()
  const obj = { id, name: name.trim(), content: '', createdAt: Date.now(), updatedAt: Date.now(), pinned: false, highlighted: false }
  items.value.unshift(obj)
  save()
  internalSelectedId.value = id
  emit('select', { ...obj })
}

function renameSelected() {
  const node = current.value
  if (!node) return
  const name = window.prompt('é‡å‘½åæ ‡ç­¾ï¼š', node.name || '')
  if (!name) return
  node.name = name.trim()
  node.updatedAt = Date.now()
  save()
}

function deleteSelected() {
  const node = current.value
  if (!node) return
  if (!window.confirm(`ç¡®å®šåˆ é™¤æ ‡ç­¾â€?{node.name}â€å—ï¼Ÿ`)) return
  const idx = items.value.findIndex(i => i.id === node.id)
  if (idx >= 0) items.value.splice(idx, 1)
  save()
  if (items.value.length) {
    internalSelectedId.value = items.value[0].id
    emit('select', { ...items.value[0] })
  } else {
    internalSelectedId.value = null
    emit('select', null)
  }
}

function toggleTimeSort() {
  sortMode.value = 'time'
  sortTimeDesc.value = !sortTimeDesc.value
}
function toggleNameSort() {
  sortMode.value = 'name'
  sortNameAsc.value = !sortNameAsc.value
}

function updateSelectedContent(newContent) {
  const n = current.value
  if (!n) return
  n.content = newContent ?? ''
  n.updatedAt = Date.now()
  // è½»é‡é˜²æŠ–ï¼šå»¶è¿Ÿå†™å…?  clearTimeout(updateTimer)
  updateTimer = setTimeout(() => save(), 400)
}

let updateTimer = null

function formatTime(ts) {
  try {
    const d = new Date(ts)
    return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`
  } catch { return '' }
}

defineExpose({ updateSelectedContent })
</script>

<style scoped>
.main-label-manager {
  width: 280px;
  min-width: 280px;
  max-width: 280px;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
  padding: 10px 8px;
  border-right: 1px solid var(--weilin-prompt-ui-border-color);
  background: var(--weilin-prompt-ui-primary-bg);
  /* ç‹¬ç«‹æ»šåŠ¨å¸ƒå±€çš„å…³é”®ï¼šé™åˆ¶æ•´ä½“é«˜åº¦å¹¶è®©åˆ—è¡¨å†…éƒ¨æ»šåŠ¨ */
  height: 100%;
  max-height: calc(100vh - var(--weilin-left-panel-offset, 100px)); /* é¢„ç•™é¡¶éƒ¨çª—å£æ ‡é¢˜/è¾¹è·ï¼Œå¯æŒ‰éœ€è°ƒæ•´ */
  overflow: hidden; /* é˜²æ­¢éšåˆ—è¡¨å¢é•¿è€Œæ‹‰é•¿æ•´ä½“é¡µé?*/
}

.mlm-header {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.mlm-search {
  width: 100%;
  height: 32px;
  border-radius: 6px;
  border: 1px solid var(--weilin-prompt-ui-border-color);
  background: var(--weilin-prompt-ui-input-bg);
  color: var(--weilin-prompt-ui-primary-text);
  padding: 0 8px;
}

.mlm-add {
  background: #28a745;
  color: #fff;
  border: none;
  border-radius: 6px;
  height: 32px;
  width: 100%;
  cursor: pointer;
}

.mlm-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  width: 100%;
}

.mlm-list {
  margin-top: 8px;
  /* å›ºå®šå¯è§†é«˜åº¦çº?15 è¡Œï¼ˆæ¯è¡Œçº?48px: 36 é«˜åº¦ + 12 é—´è·ï¼?/
  max-height: var(--weilin-main-label-list-max-height, 720px); /* 48 * 15 */
  flex: 0 0 auto; /* ä¸å æ»¡å‰©ä½™é«˜åº¦ï¼Œè¶…è¿‡æ—¶åœ¨å†…éƒ¨æ»šåŠ¨ */
  overflow-y: auto;
  padding-right: 4px;
}
.mlm-list::-webkit-scrollbar {
  width: 6px;
}
.mlm-list::-webkit-scrollbar-thumb {
  background: var(--weilin-prompt-ui-scrollbar-thumb);
  border-radius: 3px;
}

.mlm-item {
  display: flex;
  align-items: center;
  min-height: 36px;
  padding: 6px 10px;
  margin: 6px 0;
  background: var(--weilin-prompt-ui-secondary-bg);
  color: var(--weilin-prompt-ui-primary-text);
  border-radius: 6px;
  cursor: pointer;
  border: 1px solid var(--weilin-prompt-ui-border-color);
}
.mlm-item.active {
  outline: 2px solid var(--weilin-prompt-ui-primary-color);
}
.mlm-name {
  font-size: 13px;
}

.mlm-sort {
  height: 32px;
  font-size: 12px;
  border: 1px solid var(--weilin-prompt-ui-border-color);
  background: var(--weilin-prompt-ui-button-bg);
  color: var(--weilin-prompt-ui-button-text);
  border-radius: 4px;
  width: 100%;
  cursor: pointer;
}
.mlm-edit,
.mlm-delete {
  height: 32px;
  border-radius: 4px;
  border: 1px solid var(--weilin-prompt-ui-border-color);
  background: var(--weilin-prompt-ui-button-bg);
  color: var(--weilin-prompt-ui-button-text);
  width: 100%;
  cursor: pointer;
}
.mlm-delete {
  background: #a52a2a20;
  color: #ff6b6b;
}

.mlm-grid button:disabled {
  cursor: not-allowed;
  opacity: 0.7;
}
</style>

